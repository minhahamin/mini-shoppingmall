<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>장바구니 - 미니 쇼핑몰</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-container">
            <a href="/" class="logo">🛍️ Mini Shopping Mall</a>
            <nav class="nav-links">
                <a href="/">홈</a>
                <a href="/products">상품</a>
                <a href="/cart">장바구니</a>
                <a href="/order/history">주문내역</a>
                <a href="/admin/products" sec:authorize="hasRole('ADMIN')">관리자</a>
                <form sec:authorize="isAuthenticated()" th:action="@{/logout}" method="post" style="display: inline;">
                    <button type="submit" class="btn-logout" style="cursor: pointer;">로그아웃</button>
                </form>
            </nav>
        </div>
    </header>

    <!-- Cart Content -->
    <div class="container" style="margin-top: 40px;">
        <h2 style="margin-bottom: 30px;">장바구니</h2>
        
        <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
        <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>
        
        <div th:if="${cart.items.isEmpty()}" style="text-align: center; padding: 80px 20px;">
            <p style="font-size: 1.2rem; color: #999; margin-bottom: 20px;">장바구니가 비어있습니다</p>
            <a href="/products" class="btn-primary">쇼핑 계속하기</a>
        </div>
        
        <div th:unless="${cart.items.isEmpty()}">
            <div class="admin-table">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 50px;">
                                <input type="checkbox" id="selectAll" onclick="toggleSelectAll()" />
                            </th>
                            <th>상품 이미지</th>
                            <th>상품명</th>
                            <th>가격</th>
                            <th>수량</th>
                            <th>소계</th>
                            <th>관리</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="item : ${cart.items}" onclick="toggleRowCheckbox(event, this)" style="cursor: pointer;">
                            <td onclick="event.stopPropagation();">
                                <input type="checkbox" class="item-checkbox" th:value="${item.id}" 
                                       onclick="event.stopPropagation(); updateSelectedTotal()" />
                            </td>
                            <td>
                                <img th:src="${item.product.imageUrl != null ? item.product.imageUrl : 'https://via.placeholder.com/80x80'}" 
                                     th:alt="${item.product.name}"
                                     style="width: 80px; height: 80px; object-fit: cover; border-radius: 5px;" />
                            </td>
                            <td>
                                <a th:href="@{/products/{id}(id=${item.product.id})}" 
                                   style="color: #667eea; text-decoration: none; font-weight: 500;">
                                    <span th:text="${item.product.name}"></span>
                                </a>
                            </td>
                            <td th:text="|${#numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT')}원|"></td>
                            <td onclick="event.stopPropagation();">
                                <form th:action="@{/cart/update/{id}(id=${item.id})}" method="post" style="display: inline-flex; align-items: center; gap: 10px;">
                                    <input type="number" name="quantity" th:value="${item.quantity}" 
                                           min="1" th:max="${item.product.stock}"
                                           style="width: 60px; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                                    <button type="submit" class="btn-small btn-edit">변경</button>
                                </form>
                            </td>
                            <td th:text="|${#numbers.formatDecimal(item.subtotal, 0, 'COMMA', 0, 'POINT')}원|" 
                                style="font-weight: bold;" 
                                th:data-price="${item.subtotal}"></td>
                            <td onclick="event.stopPropagation();">
                                <form th:action="@{/cart/remove/{id}(id=${item.id})}" method="post" style="display: inline;"
                                      onsubmit="return confirm('이 상품을 장바구니에서 삭제하시겠습니까?');">
                                    <button type="submit" class="btn-small btn-delete">삭제</button>
                                </form>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 30px; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="margin-bottom: 10px;">선택 상품 금액</h3>
                        <p style="font-size: 2rem; color: #667eea; font-weight: bold; margin: 0;">
                            <span id="selectedTotal">0</span>원
                        </p>
                        <p style="font-size: 0.9rem; color: #888; margin-top: 5px;">
                            전체 금액: <span th:text="|${#numbers.formatDecimal(total, 0, 'COMMA', 0, 'POINT')}원|"></span>
                        </p>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button onclick="deleteSelected()" style="padding: 12px 24px; background-color: #f44336; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; font-weight: 500;">
                            선택 삭제
                        </button>
                        <a href="/products" style="padding: 12px 24px; background-color: #888; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; font-weight: 500; text-decoration: none; display: inline-block;">
                            쇼핑 계속하기
                        </a>
                        <button onclick="orderSelected()" style="padding: 12px 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1rem; font-weight: 600;">
                            주문하기
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 행 클릭 시 체크박스 토글
        function toggleRowCheckbox(event, row) {
            // 버튼이나 링크를 클릭한 경우는 무시
            if (event.target.tagName === 'BUTTON' || 
                event.target.tagName === 'A' || 
                event.target.tagName === 'INPUT') {
                return;
            }
            
            const checkbox = row.querySelector('.item-checkbox');
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                updateSelectedTotal();
            }
        }
        
        // 전체 선택/해제
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.item-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            updateSelectedTotal();
        }
        
        // 선택된 항목의 총 금액 계산
        function updateSelectedTotal() {
            const checkboxes = document.querySelectorAll('.item-checkbox:checked');
            let total = 0;
            
            checkboxes.forEach(checkbox => {
                const row = checkbox.closest('tr');
                const priceCell = row.querySelector('td[data-price]');
                if (priceCell) {
                    total += parseFloat(priceCell.dataset.price);
                }
            });
            
            // 천단위 콤마 추가
            document.getElementById('selectedTotal').textContent = 
                total.toLocaleString('ko-KR', {minimumFractionDigits: 0, maximumFractionDigits: 0});
            
            // 전체 선택 체크박스 상태 업데이트
            const allCheckboxes = document.querySelectorAll('.item-checkbox');
            const selectAllCheckbox = document.getElementById('selectAll');
            selectAllCheckbox.checked = allCheckboxes.length > 0 && 
                                        checkboxes.length === allCheckboxes.length;
        }
        
        // 선택된 항목 삭제
        function deleteSelected() {
            const checkboxes = document.querySelectorAll('.item-checkbox:checked');
            
            if (checkboxes.length === 0) {
                alert('삭제할 상품을 선택해주세요');
                return;
            }
            
            if (!confirm(`선택한 ${checkboxes.length}개 상품을 삭제하시겠습니까?`)) {
                return;
            }
            
            const itemIds = Array.from(checkboxes).map(cb => cb.value);
            
            // 폼 생성하여 서버로 전송
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/cart/remove-selected';
            
            itemIds.forEach(id => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'itemIds';
                input.value = id;
                form.appendChild(input);
            });
            
            document.body.appendChild(form);
            form.submit();
        }
        
        // 선택된 항목 주문
        function orderSelected() {
            const checkboxes = document.querySelectorAll('.item-checkbox:checked');
            
            if (checkboxes.length === 0) {
                alert('주문할 상품을 선택해주세요');
                return;
            }
            
            const itemIds = Array.from(checkboxes).map(cb => cb.value);
            
            // 주문 페이지로 이동
            const params = new URLSearchParams();
            itemIds.forEach(id => params.append('itemIds', id));
            window.location.href = '/order/checkout?' + params.toString();
        }
        
        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            updateSelectedTotal();
        });
    </script>
</body>
</html>

